{% extends "general_base.html" %}
{% block content %}
    <div class="container mt-4">
        <h2>Create Prescription</h2>
        <form method="post" enctype="multipart/form-data">
            {% csrf_token %}
            <div class="row">
                <!-- Patient Info -->
                <div class="col-md-6">
                    <label for="id_patient">Patient</label>
                    {{ form.patient }}
                    <div id="patient-details" class="mt-3">
                        <p><strong>Name:</strong> <span id="patient-name"></span></p>
                        <p><strong>Age:</strong> <span id="patient-age"></span></p>
                        <p><strong>Gender:</strong> <span id="patient-gender"></span></p>
                    </div>
                </div>

                <!-- Physician Info (auto-filled) -->
                <div class="col-md-6">
                    <label for="id_physician">Physician</label>
                    <input type="text" class="form-control" value="{{ physician.username }}" disabled />
                </div>

                <!-- Date Prescribed -->
                <div class="col-md-6">
                    <label for="id_date_prescribed">Date Prescribed</label>
                    <input type="text" class="form-control" value="{{ current_date }}" disabled />
                </div>
            </div>

            <div class="mt-4">
                <h4>Prescribed Medicines</h4>
                <table class="table table-bordered">
                    <thead>
                        <tr>
                            <th>Medicine</th>
                            <th>Dose</th>
                            <th>Frequency</th>
                            <th>Timing</th>
                            <th>Amount</th>
                            <th>Additional Instructions</th>
                        </tr>
                    </thead>
                    <tbody id="medicine-table-body">
                        {% for form in medicine_formset %}
                            <tr class="medicine-row">
                                <td>{{ form.medicine }}</td>
                                <td>{{ form.dose }}</td>
                                <td>{{ form.frequency }}</td>
                                <td>{{ form.timing }}</td>
                                <td>{{ form.amount }}</td>
                                <td>{{ form.additional_instructions }}</td>
                            </tr>
                        {% endfor %}
                    </tbody>
                </table>
                <button type="button" id="add-medicine" class="btn btn-secondary">+</button>
            </div>

            <!-- Notes and Diagnosis -->
            <div class="form-group mt-4">
                <label for="id_notes">Notes</label>
                {{ form.notes }}
            </div>

            <div class="form-group mt-4">
                <label for="id_diagnosis">Diagnosis</label>
                {{ form.diagnosis }}
            </div>

            <div class="form-group mt-4">
                <label for="id_follow_up_date">Follow-up Date</label>
                {{ form.follow_up_date }}
            </div>

            <!-- Save & Print -->
            <div class="form-group mt-4">
                <button type="submit" class="btn btn-primary">Save & Print</button>
            </div>
        </form>
    </div>
{% endblock content %}

{% block scripts %}
    <script>
    $(document).ready(function() {
        // Fetch patient details based on selected patient
        $('#id_patient').on('change', function() {
            var patientId = $(this).val();
            if (patientId) {
                $.ajax({
                    url: "/get_patient_details/" + patientId + "/",
                    method: "GET",
                    success: function(response) {
                        // Auto-fill patient details (name, age, gender)
                        $('#patient-name').text(response.name);
                        $('#patient-age').text(response.age);
                        $('#patient-gender').text(response.gender);
                    }
                });
            }
        });

        // Add new medicine row
        $('#add-medicine').on('click', function() {
            // Create the new row with the medicines options rendered directly in the HTML
            var newRow = `<tr class="medicine-row">
                <td><select name="medicine" class="form-select">
                    {% for medicine in medicines %}
                        <option value="{{ medicine.id }}">{{ medicine.name }}</option>
                    {% endfor %}
                </select></td>
                <td><input type="text" name="dose" class="form-control" /></td>
                <td><input type="text" name="frequency" class="form-control" /></td>
                <td><input type="text" name="timing" class="form-control" /></td>
                <td><input type="number" name="amount" class="form-control" /></td>
                <td><input type="text" name="additional_instructions" class="form-control" /></td>
            </tr>`;

            // Append the new row to the table
            $('#medicine-table-body').append(newRow);
        });
    });
    </script>
{% endblock scripts %}


{% extends "general_base.html" %}
{% block page_specific_links %}
    <script src="https://code.jquery.com/jquery-3.6.4.min.js"></script>
{% endblock page_specific_links %}
{% block content %}
    <div class="container mt-2">
        <div class="container col-8 border rounded-4">
            <div class="text-center py-2">
                <h4>{{ action }} {{ model }}</h4>
            </div>
            <form method="post" id="form">
                {% csrf_token %}
                <div class="mb-3">
                    {{ form.as_p }}
                    <div class="d-grid gap-2 d-md-block text-end">
                        <button type="button" class="btn btn-danger" onclick="goBackAndRefresh()">Cancel</button>
                        <button type="button" class="btn btn-danger" id="clearButton">Clear</button>
                        <button type="submit" class="btn btn-primary w-25">Add {{ model }}</button>
                    </div>
                </div>
            </form>
        </div>
    </div>
{% endblock content %}
{% block scripts %}
    <script>
    $(document).ready(function() {
        // Function to check VIP status and handle discount field visibility
        function checkVipStatus(patientId) {
            if (patientId) {
                // Get CSRF token
                const csrftoken = document.querySelector('[name=csrfmiddlewaretoken]').value;
                
                // Make AJAX request to check VIP status
                $.ajax({
                    url: '{% url "check_patient_vip" %}',
                    type: 'GET',
                    data: {
                        'patient_id': patientId
                    },
                    headers: {
                        'X-CSRFToken': csrftoken
                    },
                    success: function(response) {
                        if (response.is_vip) {
                            // Show discount field if patient is VIP
                            $('#id_discount').closest('p').show();
                        } else {
                            // Hide discount field if patient is not VIP
                            $('#id_discount').closest('p').hide();
                            // Clear any selected discount
                            $('#id_discount').val('');
                        }
                    },
                    error: function(xhr, errmsg, err) {
                        console.error('Error checking VIP status:', errmsg);
                        // Hide discount field on error
                        $('#id_discount').closest('p').hide();
                        $('#id_discount').val('');
                    }
                });
            } else {
                // Hide discount field if no patient is selected
                $('#id_discount').closest('p').hide();
                $('#id_discount').val('');
            }
        }
    
        // Check VIP status on page load if patient is already selected
        const initialPatientId = $('#id_patient').val();
        checkVipStatus(initialPatientId);
    
        // When patient selection changes
        $('#id_patient').change(function() {
            const patientId = $(this).val();
            checkVipStatus(patientId);
        });
    
        // Clear button functionality
        document.getElementById('clearButton').addEventListener('click', function() {
            document.getElementById('form').reset();
            // Hide discount field when form is cleared
            $('#id_discount').closest('p').hide();
        });
    });
    </script>
{% endblock scripts %}

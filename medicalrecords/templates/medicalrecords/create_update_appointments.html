{% extends "general_base.html" %}
{% block page_specific_links %}
    <script src="https://code.jquery.com/jquery-3.6.4.min.js"></script>
{% endblock page_specific_links %}
{% block content %}
    <div class="container mt-2">
        <div class="container col-8 border rounded-4">
            <div class="text-center py-2">
                <h4>{{ action }} {{ model }}</h4>
            </div>
            <form method="post" id="form">
                {% csrf_token %}
                <div class="mb-3">
                    {{ form.as_p }}
                    <div class="d-grid gap-2 d-md-block text-end">
                        <button type="button" class="btn btn-danger" onclick="goBackAndRefresh()">Cancel</button>
                        <button type="button" class="btn btn-danger" id="clearButton">Clear</button>
                        <button type="submit" class="btn btn-primary w-25">Add {{ model }}</button>
                    </div>
                </div>
            </form>
        </div>
    </div>
{% endblock content %}
{% block scripts %}
    <script>
        $(document).ready(function () {
            let availableTimeSlots = [];
          
            // Format dates for display
            function formatDateForDisplay(dateStr) {
                const date = new Date(dateStr);
                return date.toLocaleDateString("en-US", {
                    weekday: "short",
                    month: "short",
                    day: "numeric",
                });
            }
        
            // Check VIP status and handle discount field visibility
            function checkVipStatus(patientId) {
                if (patientId) {
                    const csrftoken = document.querySelector('[name=csrfmiddlewaretoken]').value;
                    $.ajax({
                        url: '{% url "check_patient_vip" %}',
                        type: 'GET',
                        data: { 'patient_id': patientId },
                        headers: { 'X-CSRFToken': csrftoken },
                        success: function(response) {
                            if (response.is_vip) {
                                $('#id_discount').closest('p').show();
                            } else {
                                $('#id_discount').closest('p').hide();
                                $('#id_discount').val('');
                            }
                        },
                        error: function(xhr, errmsg, err) {
                            console.error('Error checking VIP status:', errmsg);
                            $('#id_discount').closest('p').hide();
                            $('#id_discount').val('');
                        }
                    });
                } else {
                    $('#id_discount').closest('p').hide();
                    $('#id_discount').val('');
                }
            }
        
            // Prepopulate the date and time fields for updates
            function prepopulateDateTime(savedDate, savedTime) {
                if (savedDate) {
                    console.log("Pre-selecting saved date:", savedDate);
                    console.log("Pre-selecting saved time:", savedTime);
                    const physicianId = $("#id_physician").val();
                    if (physicianId) {
                        // For updates, we want to keep the time field enabled
                        $("#id_time").prop('disabled', false);
                        fetchAvailableDates(savedDate, savedTime);
                    }
                }
            }
        
            function fetchAvailableDates(savedDate = null, savedTime = null) {
                const physicianId = $("#id_physician").val();
                const isUpdate = savedDate && savedTime;
            
                // Always enable time selection during updates
                $("#id_time").prop('disabled', false);
            
                $("#id_date").empty().append('<option value="">Select Date</option>');
                if (!isUpdate) {
                    $("#id_time").empty().append('<option value="">Select Time</option>');
                }
            
                if (physicianId) {
                    const csrftoken = document.querySelector("[name=csrfmiddlewaretoken]").value;
            
                    $.ajax({
                        url: '{% url "get_available_dates" %}',
                        type: "GET",
                        data: { physician_id: physicianId },
                        dataType: "json",
                        headers: {
                            "X-CSRFToken": csrftoken,
                            Accept: "application/json",
                        },
                        success: function (response) {
                            console.log("Success - Full response:", response);
            
                            if (response.available_dates) {
                                availableTimeSlots = response.available_dates;
            
                                // Add available dates to the dropdown
                                response.available_dates.forEach(function (item) {
                                    if (item && item.date) {
                                        const formattedDate = formatDateForDisplay(item.date);
                                        const isSelected = savedDate === item.date ? "selected" : "";
                                        $("#id_date").append(
                                            `<option value="${item.date}" ${isSelected}>${formattedDate}</option>`
                                        );
                                    }
                                });
            
                                // For updates, we want to ensure the saved date is selected
                                if (isUpdate) {
                                    $("#id_date").val(savedDate);
                                    populateTimeSlots(savedDate, savedTime, true);
                                }
                            }
                        },
                        error: function (xhr, errmsg, err) {
                            console.error("Error fetching dates:", errmsg);
                        },
                    });
                }
            }
            
        
            function populateTimeSlots(selectedDate, savedTime = null, isUpdate = false) {
                // Always enable time selection during updates
                $("#id_time").prop('disabled', false);
            
                if (!isUpdate) {
                    $("#id_time").empty().append('<option value="">Select Time</option>');
                }
            
                if (selectedDate) {
                    const dateData = availableTimeSlots.find((d) => d.date === selectedDate);
                    if (dateData && dateData.times && dateData.times.length > 0) {
                        dateData.times.forEach(function (time) {
                            const timeRange = `${time.start} - ${time.end}`;
                            const isSelected = savedTime === timeRange ? "selected" : "";
                            $("#id_time").append(
                                `<option value="${time.start}" ${isSelected}>${timeRange}</option>`
                            );
                        });
                    } else if (!isUpdate) {
                        $("#id_time").html('<option value="">No available times</option>');
                    }
                } else if (!isUpdate) {
                    $("#id_time").prop('disabled', true);
                }
            }
            
        
            // Initialize everything
            const savedDate = "{{ form.date.value|escapejs }}";
            const savedTime = "{{ form.time.value|escapejs }}";
            
            // Check VIP status on page load if patient is already selected
            const initialPatientId = $('#id_patient').val();
            checkVipStatus(initialPatientId);
            
            // Handle saved instance
            if ($("#id_physician").val()) {
                prepopulateDateTime(savedDate, savedTime);
            }
        
            // Event Handlers
            $('#id_patient').change(function() {
                const patientId = $(this).val();
                checkVipStatus(patientId);
            });
        
            $("#id_physician").change(function () {
                // Reset saved values when physician changes
                fetchAvailableDates();
            });
        
            $("#id_date").change(function () {
                const selectedDate = $(this).val();
                if (selectedDate) {
                    populateTimeSlots(selectedDate);
                } else {
                    $("#id_time").prop('disabled', true);
                    $("#id_time").html('<option value="">Select Date First</option>');
                }
            });
        
            // Clear button functionality
            $("#clearButton").click(function () {
                document.getElementById("form").reset();
                $("#id_date").html('<option value="">Select Date</option>');
                $("#id_time").html('<option value="">Select Time</option>').prop('disabled', true);
                $('#id_discount').closest('p').hide();
                $('#id_discount').val('');
                availableTimeSlots = [];
            });
        }); 
        
        // Function for Cancel button
        function goBackAndRefresh() {
            window.location.href = document.referrer;
        }
    </script>
{% endblock scripts %}
